config:
  connection:
    platform: vAaS #cloudplatform
    credentials:
      apiKey: '{{ Env "TLSPC_APIKEY" }}'
certificateTasks:
  - name: IIS # Task Identifier, no relevance in tool run
    renewBefore: 20%
    setEnvVars: ["thumbprint"]
    request:
      csr: local
      subject:
        commonName: '{{ Env "TLSPC_Hostname" }}.mimdemo.com'
        country: GB
        locality: London
        state: London
        organization: Venafi
        orgUnits:
          - vcert
      sanDNS: 
        - '{{ Hostname | ToLower -}}.venafidemo.com'
      zone: 'IIS pull\ztAllowAll'
    installations:
      - format: CAPI
        capiLocation: 'LocalMachine\MY'
        capiFriendlyName: 'vCert Playbook - TLSPC_US_IIS'
        capiIsNonExportable: True
        #Creates bindings for the specified ports and updates existing bindings."
        afterInstallAction:  $siteName = $Env:TLSPC_Hostname; $ports = @(443, 8443); $hostname = "*"; Import-Module WebAdministration; foreach ($port in $ports) { $bindingInfo = "*:${port}:${hostname}"; if (-not (Get-WebBinding -Name $siteName | Where-Object { $_.protocol -eq "https" -and $_.bindingInformation -eq $bindingInfo })) { New-WebBinding -Name $siteName -Protocol https -Port $port -IPAddress "*" -HostHeader $hostname -SslFlags 1 } }; Get-WebBinding -Name $siteName | Where-Object { $_.protocol -eq "https" } | ForEach-Object { $_.AddSslCertificate(${Env:VCERT_IIS_THUMBPRINT}, "My") } 


